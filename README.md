# Spotify_YM_live_sync

Утилита для двусторонней синхронизации лайков между Yandex Music и Spotify с возможностью уведомлений в Telegram.

Проще говоря — скрипт периодически проверяет понравившиеся треки в Yandexn Music и в Spotify и добавляет отсутствующие треки в противоположный сервис. Поддерживается простая проверка совпадения по названию/артисту и по длительности, логирование и Telegram-уведомления о добавленных треках и ошибках.

---

Содержание
- [Особенности](#особенности)
- [Требования](#требования)
- [Установка](#установка)
- [Конфигурация](#конфигурация)
- [Запуск](#запуск)
- [Команды Telegram-бота](#команды-telegram-бота)
- [Файл ignore_list.json](#файл-ignore_listjson)
- [Отладка и типичные проблемы](#отладка-и-типичные-проблемы)

---

## Особенности
- Двусторонняя синхронизация: Yandex -> Spotify и Spotify -> Yandex.
- Фильтрация по схожести текста (artist - title) и по длительности трека.
- Автоматический повтор попыток и игнорирование проблемных треков через конфиг.
- Уведомления в Telegram (опционально).
- Простая настройка через .env.

## Требования
- Python 3.8+
- Библиотеки в `requirements.txt`:
  - schedule
  - yandex-music
  - spotipy>=2.19.0
  - python-dotenv
  - pyTelegramBotAPI

## Установка
1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/ZxcTimurka/Spotify_YM_live_sync.git
   ```
3. Перейдите в папку проекта:
   ```bash
   cd Spotify_YM_live_sync
   ```
5. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

## Конфигурация
Переименуйте `.env.example` в `.env` и заполните значения:

- `YANDEX_TOKEN` — токен Yandex.Music.
  - Инструкция как получить токен: https://yandex-music.readthedocs.io/en/main/token.html
- `SPOTIPY_CLIENT_ID` — client id вашего Spotify-приложения (создаётся в Dashboard).
- `SPOTIPY_CLIENT_SECRET` — client secret Spotify-приложения.
- `SPOTIPY_REDIRECT_URI` — Redirect URI, который вы указали при создании приложения (например `http://127.0.0.1:8888/callback`).
- `TELEGRAM_BOT_TOKEN` — токен Telegram-бота (опционально).
- `TELEGRAM_CHAT_ID` — id чата для отправки уведомлений (опционально).

Примечание по Spotify OAuth:
- При первом запуске Spotipy откроет в браузере страницу для авторизации. После подтверждения доступа скрипт получит токен и сохранит его локально (файл кеша, например `.cache`).
- Для запуска на сервере без веб-браузера используйте перенаправление на заранее настроенный redirect URI и применяйте способ авторизации, удобный для вашего окружения.

## Запуск
1. Убедитесь, что зависимости установлены и `.env` настроен.
2. Запустите:
   ```bash
   python live_sync.py
   ```

Что происходит при запуске:
- (Опционально) запускается Telegram-бот в отдельном потоке, если заданы `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHAT_ID`.
- Выполняется один полный цикл синхронизации (Yandex -> Spotify и Spotify -> Yandex).
- Затем запускается цикл-планировщик, выполняющий синхронизацию каждые `check_interval_minutes`.

## Команды Telegram-бота
(доступны, если настроен `TELEGRAM_BOT_TOKEN`)
- /start — запуск бота.
- /status — показать текущий статус, статистику (сколько добавлено, ошибок и т.д.).
- /sync — принудительно запустить синхронизацию.

Telegram также используется для оповещений о добавленных треках и критических ошибках.

## Файл ignore_list.json
- Содержит счётчики неудачных попыток для конкретных треков.
- Если трек не удалось корректно сопоставить в течение `max_retries` попыток, он будет пропускаться (чтобы избежать постоянных ошибок из-за отсутствия трека).
- Вы можете удалить или очистить `ignore_list.json`, чтобы повторно попытаться добавить ранее пропущенные треки.

## Отладка и типичные проблемы
- "Ошибка инициализации API" — проверьте правильность токенов и доступность интернета.
- Spotify OAuth: если авторизация не проходит на headless-сервере — используйте локальную машину для первичной авторизации или настройте redirect URI, доступный вам.
- Если треки не находятся:
  - Попробуйте уменьшить `match_threshold` или увеличить `scan_limit`.
  - Проверьте, что имена артистов/треков не содержат нетипичных символов, которые мешают поиску.
- Ограничения API / Rate limits: при массовых операциях возможны ограничения; скрипт делает паузу 0.5s между операциями и имеет базовую обработку ошибок.
- Логи выводятся в stdout. Для детальной отладки можно изменить уровень логирования в `logging.basicConfig(level=...)` в `live_sync.py`.

## Советы по эксплуатации
- Запустите скрипт через systemd / supervisor / pm2 / docker в зависимости от окружения.
- Регулярно проверяйте `ignore_list.json`, если хотите повторно попробовать ранее ошибочные треки.
- Если вы хотите синхронизировать больше треков за проход — увеличьте `scan_limit`, но следите за лимитами API.
